name: Max Pain Calculator

# ---------------------------------------------------------------------------
# Triggers
# ---------------------------------------------------------------------------
on:
  # 1. Manual run — full control over ticker list and expiration date
  workflow_dispatch:
    inputs:

      ticker_file:
        description: 'Ticker list CSV (path relative to python/)'
        required: true
        default: 'user_input/test.csv'
        type: choice
        options:
          - user_input/test.csv
          - user_input/nasdaq100_tickers.csv
          - user_input/sp500_tickers.csv
          - user_input/russell3000_tickers.csv
          - user_input/iwm1000_tickers.csv

      expiration_date:
        description: |
          Expiration date.
          Keywords: current_3Fr_monthly | next_3Fr_monthly
          Or a specific date: YYYY-MM-DD (e.g. 2026-03-21)
        required: true
        default: 'next_3Fr_monthly'
        type: string

  # 2. Scheduled run — every 3rd Friday of the month at 21:30 UTC (5:30 pm ET)
  #    Cron does not support "nth weekday" natively, but the 3rd Friday always
  #    falls between the 15th and 21st of the month, so this pattern is exact.
  schedule:
    - cron: '30 21 15-21 * 5'

# ---------------------------------------------------------------------------
# Job
# ---------------------------------------------------------------------------
jobs:
  max-pain:
    name: Calculate Max Pain
    runs-on: ubuntu-latest

    # All run steps execute inside the python/ subdirectory
    defaults:
      run:
        working-directory: python

    steps:

      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: python/requirements.txt

      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # Patch expiration_date in config.ini.
      # On scheduled runs inputs are empty — fall back to next_3Fr_monthly.
      # sed -i preserves all comments and other keys unchanged.
      - name: Set expiration date
        env:
          EXP_DATE: ${{ inputs.expiration_date || 'next_3Fr_monthly' }}
        run: |
          sed -i "s/^expiration_date = .*/expiration_date = ${EXP_DATE}/" config.ini
          echo "expiration_date set to: ${EXP_DATE}"

      # -----------------------------------------------------------------------
      # Patch source = YF (CBOE bulk download is not supported — see README)
      - name: Ensure data source is YF
        run: |
          sed -i "s/^source = .*/source = YF/" config.ini

      # -----------------------------------------------------------------------
      - name: Run Max Pain Calculator
        env:
          TICKER_FILE: ${{ inputs.ticker_file || 'user_input/test.csv' }}
        run: |
          echo "Ticker file : ${TICKER_FILE}"
          python main.py --ticker-file "${TICKER_FILE}"

      # -----------------------------------------------------------------------
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: max-pain-results-${{ github.run_id }}
          path: python/results/
          retention-days: 90

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: max-pain-logs-${{ github.run_id }}
          path: python/logs/
          retention-days: 30
